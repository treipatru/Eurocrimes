function resizeRefresh(){clearTimeout(resizeId),iniScrWidth!==screen.width&&(resizeId=setTimeout(doneResizing,500))}function doneResizing(){location.reload(),console.log("resized")}function chordMpr(a){var f,g,b={},c={},d=0,e=[];return b.setFilter=function(a){return f=a,this},b.setAccessor=function(a){return g=a,this},b.getMatrix=function(){return e=[],_.each(c,function(b){e[b.id]||(e[b.id]=[]),_.each(c,function(c){var d=_.filter(a,function(a){return f(a,b,c)});e[b.id][c.id]=g(d,b,c)})}),e},b.getMap=function(){return c},b.printMatrix=function(){_.each(e,function(a){console.log(a)})},b.addToMap=function(a,b){c[a]||(c[a]={name:a,id:d++,data:b})},b.addValuesToMap=function(b,e){var f=_.uniq(_.pluck(a,b));return _.map(f,function(a){c[a]||(c[a]={name:a,id:d++,data:e})}),this},b}function chordRdr(a,b){return function(c){var d,e,f,g,h,i={};return c.source?(d=c.source.index,e=c.target.index,f=_.where(b,{id:d}),g=_.where(b,{id:e}),i.sname=f[0].name,i.sdata=c.source.value,i.svalue=+c.source.value,i.stotal=_.reduce(a[d],function(a,b){return a+b},0),i.tname=g[0].name,i.tdata=c.target.value,i.tvalue=+c.target.value,i.ttotal=_.reduce(a[e],function(a,b){return a+b},0)):(h=_.where(b,{id:c.index}),i.gname=h[0].name,i.gdata=h[0].data,i.gvalue=c.value),i.mtotal=_.reduce(a,function(a,b){return a+_.reduce(b,function(a,b){return a+b},0)},0),i}}function drawBarPrisoners(){function i(){var a=d3.scale.linear().range([0,b]),e=d3.svg.axis().scale(a).orient("bottom").ticks(5),i=d3.select("#prisonersContainer").attr("width",b);i.append("g").attr("id","prisonersGrid"),i.append("g").attr("id","prisonersBars"),d3.csv("data/bar-percentage.csv",j,function(b,j){a.domain([0,d3.max(j,function(a){return a.percentage})]),d=((f+g)*j.length+h)*c,i.attr("height",d);var m=i.select("#prisonersBars").selectAll("g").data(j).enter().append("g").attr("class","bars").attr("transform",function(a,b){return"translate(0,"+b*(f+g)+")"});m.append("rect").attr("class","barRect").style("fill","#ED9F85").attr("width",function(b){return a(b.percentage)}).attr("height",f),m.append("text").attr("class","barRectTitle selectDisallow").attr("x",5).attr("y",f/2).attr("dy",".35em").style("fill","#000000").style("font-size","0.7em").text(function(a){return a.country}),i.select("#prisonersGrid").append("g").attr("class","x axis").attr("transform","translate(0,"+(d-h)+")").call(e.tickSize(-d,3).tickPadding(5)),i.selectAll(".bars").on("mouseover",k).on("mouseout",l)})}function j(a){return a.percentage=+a.percentage,a}function k(){d3.select(this).select("rect").transition().duration(300).ease("bounce").style("fill","#ED7149"),d3.select(this).select(".barRectTitle").transition().duration(150).ease("cubic").style("opacity","0").style("font-weight","700").transition().duration(150).style("opacity","1").text(function(a){return a.percentage+" %"})}function l(){d3.select(this).select("rect").transition().duration(300).ease("exp").style("fill","#ED9F85"),d3.select(this).select(".barRectTitle").transition().duration(150).style("opacity","0").transition().style("font-weight","500").duration(150).style("opacity","1").text(function(a){return a.country})}var d,e,f,g,h,b=parseInt(d3.select("#barPrisoners").style("width")),c=1;f=20,g=8,h=20,e=d3.select("#barPrisoners").append("svg").attr("id","prisonersContainer").style("display","block").style("margin","auto"),i()}function drawBarIncome(){function k(){var a=d3.select("#salaryContainer").attr("width",b);a.append("g").attr("id","salaryGrid"),a.append("g").attr("id","salaryBars"),d3.csv("data/bar-income.csv",l,function(b,c){i.domain([0,d3.max(c,function(a){return a.income})]);var d=(f+g)*c.length+h;a.attr("height",d);var e=a.select("#salaryBars").selectAll("g").data(c).enter().append("g").attr("class","bars").attr("transform",function(a,b){return"translate(0,"+b*(f+g)+")"});e.append("rect").attr("class","barRect").style("fill","#9CD4D1").attr("width",function(a){return i(a.income)}).attr("height",f),e.append("text").attr("class","barRectTitle selectDisallow").attr("x",5).attr("y",f/2).attr("dy",".35em").style("fill","#000000").style("font-size","0.7em").text(function(a){return a.country}),a.select("#salaryGrid").append("g").attr("class","x axis").attr("transform","translate(0,"+(d-h)+")").call(j.tickSize(-d,3).tickPadding(5)),a.selectAll(".bars").on("mouseover",m).on("mouseout",n)})}function l(a){return a.income=+a.income,a}function m(){d3.select(this).select("rect").transition().duration(300).ease("bounce").style("fill","#5bc1ba"),d3.select(this).select(".barRectTitle").transition().duration(150).ease("cubic").style("opacity","0").style("font-weight","700").transition().duration(150).style("opacity","1").text(function(a){return a.income+" â‚¬"})}function n(){d3.select(this).select("rect").transition().duration(300).ease("exp").style("fill","#9CD4D1"),d3.select(this).select(".barRectTitle").transition().duration(150).style("opacity","0").transition().style("font-weight","500").duration(150).style("opacity","1").text(function(a){return a.country})}var e,f,g,h,b=parseInt(d3.select("#barPrisoners").style("width"));f=20,g=8,h=20,e=d3.select("#barIncome").append("svg").attr("id","salaryContainer").style("display","block").style("margin","auto");var i=d3.scale.linear().range([0,b]),j=d3.svg.axis().scale(i).orient("bottom").ticks(4);k()}function drawChordDiagram(){function e(){function a(a,c){function n(a){d3.format(".2%");return"Prisoner Relationship<br/>"+a.sname+" &rightarrow; "+a.tname+" : "+a.svalue+(a.sname===a.tname?"":"<br/>"+a.tname+" &rightarrow; "+a.sname+" : "+a.tvalue)}function o(a){var b=d3.format(".1%"),c=d3.format(",");return a.gname+" has "+c(a.gvalue)+" citizens in EU prisons<br/>This is "+b(a.gvalue/a.mtotal)+" of the total EU expat prison population."}function p(a,b){function j(){d3.select("#tooltip").transition().duration(400).ease("cubic").style("opacity",1)}if(d3.select("#gActive").empty()||"gActive"===d3.select(this).attr("id"))d3.select("#tooltip").style("opacity",0).style("visibility","visible").html(o(k(a))).style("top",function(){return d3.event.pageY+50+"px"}).style("left",function(){return d3.event.pageX-130+"px"}),j();else{var e,h,c=d3.select("#gActive").data()[0].index,d=d3.select("#gActive").text(),f=d3.select(this).data()[0].index,g=d3.select(this).text(),i=d3.select("#chordContainer").selectAll(".chord").filter(function(a){if(a.source.index===c&&a.target.index===f||a.source.index===f&&a.target.index===c)return a}).data();i.length<1?(e=0,h=0):(e=i[0].source.value,h=i[0].target.value),d3.select("#tooltip").style("opacity",0).style("visibility","visible").html(function(){return"Prisoner Relationship<br/>"+d+" &rightarrow; "+g+": "+e+"<br/>"+g+" &rightarrow; "+d+": "+h}).style("top",function(){return d3.event.pageY+50+"px"}).style("left",function(){return d3.event.pageX-130+"px"}),j()}d3.select(this).select("text").style("font-weight","800"),d3.select("#gActive").empty()&&d3.select(this).select("text").style("font-size","0.8em"),m.classed("fade",function(a){return a.source.index!=b&&a.target.index!=b}),d3.selectAll(".chord").filter(".fade").transition().delay(200).duration(100).style("opacity","0")}function q(a){d3.select("#tooltip").style("left",d3.event.pageX+20+"px").style("top",d3.event.pageY+20+"px")}function r(a,b){d3.select("#tooltip").style("visibility","hidden"),"gActive"===d3.select(this).attr("id")?d3.selectAll(".fade").style("visibility","hidden"):(d3.select(this).select("text").style("font-size","0.6em"),d3.selectAll(".fade").transition().delay(100).duration(100).style("opacity",.8),d3.selectAll("fade").style("visibility","hidden").classed("fade",!1),d3.select(this).select("text").style("font-weight","500"))}function s(a,b){d3.select("#gActive").empty()?(d3.select(this).attr("id","gActive"),d3.select(this).select("text").style("font-size","0.8em"),d3.select(this).select("path").style("stroke","#424242").style("stroke-width","2")):"gActive"===d3.select(this).attr("id")?(d3.select(this).attr("id",null).select("text").style("font-size","0.6em"),d3.select(this).select("path").style("stroke","none"),d3.selectAll(".fade").style("visibility","visible")):d3.select("#gActive").empty()||"gActive"===d3.select(this).attr("id")||d3.select("#gActive").select("text").transition().duration(100).ease("cubic").style("fill","red").transition().duration(100).ease("cubic").style("fill","white").transition().duration(100).ease("cubic").style("fill","red").transition().duration(100).ease("cubic").style("fill","white").transition().duration(100).ease("cubic").style("fill","black")}function t(a){d3.select("#gActive").empty()||(d3.select(this).transition().duration(250).ease("cubic").style("fill-opacity",1),d3.select("#tooltip").style("visibility","visible").html(n(k(a))).style("top",function(){return d3.event.pageY+50+"px"}).style("left",function(){return d3.event.pageX-130+"px"}))}function u(a){d3.select("#tooltip").style("left",d3.event.pageX+20+"px").style("top",d3.event.pageY+20+"px")}function v(a){d3.select(this).transition().duration(100).ease("cubic").style("fill-opacity",.8),d3.select("#tooltip").style("visibility","hidden")}var e=d/2,f=e-100,g=d3.scale.ordinal().domain(d3.range(28)).range(["#a9bccd","#d3b54d","#737fd7","#9dc067","#d78ada","#548d42","#d7609d","#62c78d","#e87579","#55799f","#d04b74","#52aabf","#ce7144","#71a5e2","#ad772e","#9966ac","#85822d","#d0acde","#c1b474","#69cec3","#e3a471","#5b886f","#b85a59","#afb998","#c47495","#98765b","#937c94","#dca8a3"]),h=d3.layout.chord().padding(.04).sortSubgroups(d3.descending).sortChords(d3.descending),i=d3.svg.arc().innerRadius(f+10).outerRadius(f+30),j=d3.select("#chordDiagram").append("svg:svg").attr("width",b).attr("height",d).attr("id","chordContainer").style("display","block").style("margin","auto").append("svg:g").attr("id","circle").attr("transform","translate("+b/2+","+d/2+")");j.append("circle").attr("r",f+20);var k=chordRdr(a,c);h.matrix(a);var l=j.selectAll("g.group").data(h.groups()).enter().append("svg:g").attr("class","group").attr("id",function(a){return"ch"+k(a).gname}).on("mouseover",p).on("mousemove",q).on("mouseout",r).on("click",s);l.append("svg:path").style("fill",function(a){return g(a.index)}).attr("d",i),l.append("svg:text").each(function(a){a.angle=(a.startAngle+a.endAngle)/2}).attr("dy",".35em").attr("class","selectDisallow").style("font-family","Open Sans, HelveticaNeue, Helvetica Neue, Helvetica, Arial, sans-serif;").style("font-size","0.6em").attr("text-anchor",function(a){return a.angle>Math.PI?"end":null}).attr("transform",function(a){return"rotate("+(180*a.angle/Math.PI-90)+")translate("+(f+36)+")"+(a.angle>Math.PI?"rotate(180)":"")}).text(function(a){return k(a).gname});var m=j.selectAll("path.chord").data(h.chords()).enter().append("svg:path").attr("class","chord").style("stroke",function(a){return d3.rgb(g(a.target.index)).darker()}).style("fill",function(a){return g(a.target.index)}).style("opacity","0.8").attr("d",d3.svg.chord().radius(f)).on("mouseover",t).on("mousemove",u).on("mouseout",v)}d3.csv("data/chord-data.csv",function(b,c){var d=chordMpr(c);d.addValuesToMap("isfrom").setFilter(function(a,b,c){return a.isfrom===b.name&&a.goesto===c.name}).setAccessor(function(a,b,c){return a[0]?+a[0].count:0}),a(d.getMatrix(),d.getMap())})}var a={top:10,left:25,right:25,bottom:10},b=parseInt(d3.select("#chordDiagram").style("width")),b=b-a.left-a.right,c=.75,d=b*c;e()}function drawJailPop(){function k(){var f=d3.select("#jailPop").append("svg").attr("id","jailPopContainer").attr("width",i).attr("height",j).style("display","block").style("margin","auto");d=f.attr("width")/100+e,f.append("text").attr("id","jailPopTitle").attr("x",i/2).attr("y",h.top).attr("class","chartTitle").attr("text-anchor","middle").style("fill","#606062").text("EU PRISON TOTAL DOMINATED BY LOCALS (%)");var k=f.selectAll("g").data(a).enter().append("g").attr("id",function(a){return String(Object.keys(a)).replace(/ /g,"")}).attr("class","sqInactive"),q=-(d+c),r=0,s=0;k.each(function(a,e){function o(){return q+=d+c,q+d>i?(q=0,r++,q):q}function p(){return s=r*(d+c)+g}for(var f=String(Object.keys(a)),h=d3.format("f")(a[f]/b),j=String(f).replace(/ /g,""),k=0;k<h;k++)d3.select("#"+j).append("rect").attr("class","sq"+j+" jailPopSquares").attr("x",o()).attr("y",p()+g).attr("rx",0).attr("ry",0).attr("width",d).attr("height",d).on("mouseover",l).on("mousemove",m).on("mouseout",n)}),r++,s=r*(d+c)+g,d3.select("#jailPopContainer").attr("height",s+h.top+h.bottom+g),d3.select("#jailPopContainer").append("g").attr("id","jailPopLegend").selectAll("g").data(a).enter().append("g").attr("id",function(a){return String(Object.keys(a))}).attr("transform",function(a,b){return"translate("+b*(d+c)+","+(s+g)+")"}).on("mouseover",o).on("mouseout",p).append("rect").attr("x",0).attr("y",0).attr("width",d).attr("height",d).attr("class",function(a){return"sq"+String(Object.keys(a)).replace(/ /g,"")}),d3.select("#jailPopLegend").selectAll("g").each(function(a,b){d3.select(this).append("text").attr("class",function(a){return"disablePointer selectDisallow sq"+String(Object.keys(a)).replace(/ /g,"")}).attr("x",d+3).attr("y",d/2).attr("dy",".35em").attr("text-anchor","left").style("fill","#606062").style("font-size","0.7em").text(function(a){return Object.keys(a)})});var t=0,u=0;d3.select("#jailPopLegend").selectAll("g").each(function(a,b){var e=d3.select(this).select("text").node().getBBox().width,f=d3.select(this.nextElementSibling),i=d3.select("#jailPopContainer").node().getBBox().width;if(f[0][0]){var j=d3.transform(f.attr("transform")).translate[0],k=d3.transform(f.attr("transform")).translate[1];j=t+j+e,j+e>i&&(j=0+u,u=d+c+e,r++,k+=d+c,s=r*(d+c)+g,d3.select("#jailPopContainer").attr("height",s+h.top+h.bottom+g)),t+=e,d3.select(this.nextElementSibling).attr("transform","translate("+j+","+k+")")}})}function l(){var a=d3.select(this);a.transition().duration(200).ease("cubic").style("opacity","0.7"),d3.select("#tooltip").style("visibility","visible").html("<p>1%</p>").style("top",function(){return d3.event.pageY+10+"px"}).style("left",function(){return d3.event.pageX-0+"px"});d3.select(this.parentNode).datum()}function m(a){d3.select("#tooltip").style("left",d3.event.pageX+20+"px").style("top",d3.event.pageY+20+"px")}function n(){var a=d3.select(this);a.transition().duration(100).delay(100).ease("cubic").style("opacity","1").attr("rx",0).attr("ry",0),d3.select("#tooltip").style("visibility","hidden")}function o(){var a=d3.select(this),b=a.attr("id").replace(/ /g,""),c=d3.select("#"+b).selectAll("rect").size();a.select("text").text(c+"%").style("font-size","0.9em").style("font-weight","900"),d3.select("#jailPopContainer").select("#"+b).attr("class","sqActive"),d3.selectAll(".sqInactive").selectAll("rect").transition().duration(200).ease("cubic").style("opacity","0.2")}function p(){var a=d3.select(this),b=a.attr("id");a.select("text").text(b).style("font-size","0.7em").style("font-weight","500"),d3.selectAll(".sqInactive").selectAll("rect").attr("dx",".35em").transition().duration(400).ease("cubic").style("opacity","1"),d3.selectAll(".sqActive").attr("class","sqInactive")}var a=[{Romanian:2},{"Other EU":4},{"Non EU":13},{Local:82}],b=1,c=20,d=0,e=20,g=20,h={top:30,left:0,bottom:20,right:35},i=parseInt(d3.select("#jailPop").style("width")),i=i-h.left-h.right,j=h.top+h.bottom;k()}function drawMap(){function f(){function k(){var a=d3.select(this);d3.selectAll(".countryActive").empty()?(a.style("opacity","0.8"),d3.select("#tooltip").style("visibility","visible").html("<p>"+a.attr("id")+"</p>").style("top",function(){return d3.event.pageY+10+"px"}).style("left",function(){return d3.event.pageX-0+"px"})):(a.style("opacity","0.8"),d3.select("#tooltip").style("visibility","visible").html("<p>"+a.attr("id")+"</p>").style("top",function(){return d3.event.pageY+10+"px"}).style("left",function(){return d3.event.pageX-0+"px"}))}function l(a){d3.select("#tooltip").style("left",d3.event.pageX+20+"px").style("top",d3.event.pageY+20+"px")}function m(){var a=d3.select(this);a.classed("countryActive")?a.style("opacity","1"):(d3.select(this).attr("class","countryEU"),a.style("opacity","1")),d3.select("#tooltip").style("visibility","hidden")}function n(){var a=d3.select("#"+this.id).attr("class");if("countryActive"===a)d3.select(this).attr("class","countryEU"),d3.selectAll(".countryEU").transition().duration(e).ease("cubic").style("fill","#217A89"),d3.selectAll(".nrCountry").transition().duration(e).ease("cubic").style("opacity",0),d3.select("#selectionTitle").transition().duration(e/2).ease("quad").style("fill","#FFFFFF").remove(),d3.select("#titleCount").transition().duration(e/2).ease("quad").style("fill","#FFFFFF").remove();else{d3.selectAll(".nrCountry").transition().duration(e).ease("cubic").style("opacity",0).text(""),d3.select(".countryActive").attr("class","countryEU"),d3.select("#selectionTitle").transition().duration(e/2).ease("quad").style("fill","#FFFFFF").remove(),d3.select("#titleCount").transition().delay(e/10).duration(e/2).ease("quad").style("fill","#FFFFFF").remove(),d3.select(this).attr("class","countryActive").transition().duration(e).ease("exp").style("fill","#F47F5E");var b=this.id;console.log(b+" is active");var c=d3.selectAll(".countryEU").data(),d=[],f=0;for(var g in c)if(c.hasOwnProperty(g)){var h={};h.host=c[g].properties.NAME,h.people=c[g].diaspora[b],d.push(h)}for(d.sort(function(a,b){return parseFloat(b.people)-parseFloat(a.people)}),j=0;j<d.length;j++)f+=parseFloat(d[j].people);d3.select("#mapContainer").append("text").attr("id","selectionTitle").attr("x",10).attr("y",50).style("opacity",0).style("fill","#E7714A").style("text-anchor","left").style("font-size","2.5em").transition().duration(e).ease("quad").style("opacity",1).text(b),d3.select("#mapContainer").append("text").attr("id","titleCount").attr("x",13).attr("y",75).style("text-anchor","left").style("font-size","0.6em").style("font-weight","700").style("fill","#606062").transition().delay(e/2).duration(2*e).ease("quad").style("opacity",.8).text(d3.format(".2s")(f)+" Expats");for(var i=d3.scale.linear().domain([5,15,35,60]).range(["#8DA9D3","#3E649D","#3E649D","#3E649D"]),j=0;j<d.length;j++){var k=(d[j].people/f*100).toFixed(2);d3.selectAll("#"+d[j].host).transition().duration(e).ease("cubic").style("fill",i(k)),d3.selectAll("#nr"+d[j].host).transition().duration(e).ease("cubic").style("opacity",1).text(d3.format(".2s")(d[j].people))}}}var a,c,f,g,h,i;a=[20,58],h=1.3*b,g=d3.geo.azimuthalEqualArea().scale(h).translate([b/2,b/5]).center(a),f=d3.geo.path().projection(g),i=d3.select("#mapDiagram").append("svg").attr("height",d).attr("id","mapContainer").attr("width",b).style("display","block").style("margin","auto"),c=i.append("g"),d3.json("./data/map.json",function(a){c.selectAll(".country").data(topojson.feature(a,a.objects.collection).features).enter().append("g").attr("class",function(a){return"1"===a.properties.EU_MEMBER?"gCountryEU":"gCountry"}).attr("id",function(a){return"g"+a.properties.NAME}).append("path").attr("class","country").attr("id",function(a){return a.properties.NAME}).attr("d",f).filter(function(a){if("1"===a.properties.EU_MEMBER)return a}).attr("class","countryEU").on("mouseover",k).on("mousemove",l).on("mouseout",m).on("click",n),d3.selectAll(".gCountryEU").append("text").attr("class","nrCountry selectDisallow disablePointer").attr("id",function(a){return"nr"+a.properties.NAME}).attr("transform",function(a){return"translate("+f.centroid(a)+")"}).attr("dy",".35em").style("font-weight","bold").style("opacity",0),d3.json("./data/mapdata.json",function(a){var b=a;for(var c in b)b.hasOwnProperty(c)&&d3.select("#"+c).datum(function(a){return a.diaspora=b[c],a})})})}var b=parseInt(d3.select("#mapDiagram").style("width")),c=.7,d=b*c,e=500;f()}var resizeId,iniScrWidth=screen.width;d3.select(window).on("resize",resizeRefresh);